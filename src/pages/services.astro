---
import { getCollection, render } from "astro:content";
import Base from "../layouts/Base.astro";
import CTA from "../components/CTA.astro";

const sections = (await getCollection("services")).sort(
  (a, b) => a.data.order - b.data.order
);

const rendered = await Promise.all(
  sections.map(async (s) => ({
    ...s,
    rendered: await render(s),
  }))
);

const icons: Record<string, string> = {
  "quick-sites": `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>`,
  "custom-builds": `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>`,
  "everything-else": `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>`,
};

let svcIdx = 0;
const processedSections = rendered.map(s => ({
  ...s,
  _svcIdx: (s.data.section !== 'intro' && s.data.section !== 'cta') ? svcIdx++ : -1,
}));
---

<Base title="Services | Plain Sight" description="Web development services â€” quick sites, custom builds, audits, redesigns, and more.">
  <main class="container pt-32 max-md:pt-24 mb-10">
    {processedSections.filter(s => s.data.section === "intro").map((section) => {
      const { Content } = section.rendered;
      const d = section.data;
      return (
        <section class="services-hero py-14 max-md:py-10 max-md:px-6 relative overflow-hidden">
          <h1 class="text-page-hero font-black tracking-tighter leading-snug mb-5 relative">{d.heading}</h1>
          <div class="services-hero-prose max-w-[960px] relative">
            <Content />
          </div>
        </section>
      );
    })}

    <div class="services-grid mb-48">
      {processedSections.filter(s => s._svcIdx >= 0).map((section, idx) => {
        const { Content } = section.rendered;
        const d = section.data;
        const isAlt = idx % 2 !== 0;

        return (
          <article class={`service-card bg-bg border border-border rounded-2xl p-6 max-md:py-6 max-md:px-5`} data-service-idx={idx}>
            <div class="card-content">
              {icons[d.section] && (
                <div class="text-accent mb-4" set:html={icons[d.section]} />
              )}
              {d.title && <h2 class="text-service-title font-bold leading-[1.2] mb-6">{d.title}</h2>}
              <p class="text-service-tagline text-text-muted leading-normal mb-5">{d.heading}</p>
            </div>
            <button class="learn-more-button" data-service-idx={idx} aria-label="Learn more about this service">
              <span>Learn more</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 12h14M12 5l7 7-7 7"/>
              </svg>
            </button>
            <div class="service-data" style="display: none;">
              <div class="service-icon" data-icon={icons[d.section]}></div>
              <div class="service-title">{d.title}</div>
              <div class="service-heading">{d.heading}</div>
              <div class="service-intro">{d.intro}</div>
              <div class="service-content"><Content /></div>
            </div>
          </article>
        );
      })}
    </div>
  </main>

  <div class="mt-40">
    {processedSections.filter(s => s.data.section === "cta").map((section) => {
      const { Content } = section.rendered;
      const d = section.data;
      return (
        <CTA heading={d.heading} ctaText={d.cta_text} ctaLink={d.cta_link}>
          <Content />
        </CTA>
      );
    })}
  </div>

  <!-- Service Modal -->
  <div id="service-modal" class="service-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-overlay"></div>
    <div class="modal-container">
      <button class="modal-close" aria-label="Close modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-icon" id="modal-icon"></div>
          <h2 class="modal-title" id="modal-title"></h2>
        </div>
        <p class="modal-heading" id="modal-heading"></p>
        <div class="modal-body">
          <p class="modal-intro" id="modal-intro"></p>
          <div class="modal-sections" id="modal-sections"></div>
          <div class="modal-cta">
            <a href="/contact" class="btn-modal-cta">Get Started</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById('service-modal');
    const modalOverlay = modal?.querySelector('.modal-overlay');
    const modalClose = modal?.querySelector('.modal-close');
    const modalIcon = document.getElementById('modal-icon');
    const modalTitle = document.getElementById('modal-title');
    const modalHeading = document.getElementById('modal-heading');
    const modalIntro = document.getElementById('modal-intro');
    const modalSections = document.getElementById('modal-sections');

    function openModal(serviceIdx: number) {
      const card = document.querySelector(`[data-service-idx="${serviceIdx}"]`);
      if (!card) return;

      const serviceData = card.querySelector('.service-data');
      if (!serviceData) return;

      // Get data from hidden service data
      const icon = serviceData.querySelector('.service-icon')?.getAttribute('data-icon');
      const title = serviceData.querySelector('.service-title')?.textContent;
      const heading = serviceData.querySelector('.service-heading')?.textContent;
      const intro = serviceData.querySelector('.service-intro')?.textContent;
      const content = serviceData.querySelector('.service-content')?.innerHTML;

      // Populate modal
      if (modalIcon && icon) modalIcon.innerHTML = icon;
      if (modalTitle) modalTitle.textContent = title || '';
      if (modalHeading) modalHeading.textContent = heading || '';
      if (modalIntro) modalIntro.textContent = intro || '';
      if (modalSections) modalSections.innerHTML = content || '';

      // Show modal
      modal?.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal?.classList.remove('modal-open');
      document.body.style.overflow = '';
    }

    // Open modal on button click
    document.querySelectorAll('.learn-more-button').forEach(button => {
      button.addEventListener('click', () => {
        const serviceIdx = button.getAttribute('data-service-idx');
        if (serviceIdx !== null) {
          openModal(parseInt(serviceIdx, 10));
        }
      });
    });

    // Close modal handlers
    modalClose?.addEventListener('click', closeModal);
    modalOverlay?.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal?.classList.contains('modal-open')) {
        closeModal();
      }
    });
  </script>
</Base>

<style>
  .services-hero-prose :global(p) {
    font-size: 1.5rem;
    color: var(--color-text-muted);
    line-height: 1.7;
  }

  /* Services grid layout */
  .services-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.25rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 1024px) {
    .services-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
  }

  /* Service card */
  .service-card {
    display: flex;
    flex-direction: column;
    position: relative;
  }

  @media (min-width: 1025px) {
    .service-card {
      height: 500px;
    }
  }

  .card-content {
    flex: 1;
  }

  /* Learn more button */
  .learn-more-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: auto;
    padding: 0.75rem 1.25rem;
    width: 100%;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    color: var(--color-accent);
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .learn-more-button:hover {
    background: var(--color-accent);
    color: var(--color-bg);
    border-color: var(--color-accent);
  }

  .learn-more-button svg {
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  .learn-more-button:hover svg {
    transform: translateX(2px);
  }

  /* Service Modal */
  .service-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .service-modal.modal-open {
    opacity: 1;
    pointer-events: auto;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
  }

  .modal-container {
    position: relative;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 1rem;
    padding: 3rem;
    overflow-y: auto;
    transform: scale(0.95);
    transition: transform 0.3s ease;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .service-modal.modal-open .modal-container {
    transform: scale(1);
  }

  @media (max-width: 768px) {
    .modal-container {
      padding: 2rem 1.5rem;
      max-height: 95vh;
    }
  }

  .modal-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    border-radius: 0.5rem;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .modal-close:hover {
    background: var(--color-surface-raised);
    color: var(--color-accent);
  }

  .modal-content {
    position: relative;
  }

  .modal-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
  }

  .modal-icon {
    color: var(--color-accent);
    flex-shrink: 0;
  }

  .modal-title {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.2;
    margin: 0;
    color: var(--color-text);
  }

  .modal-heading {
    font-size: 1.25rem;
    font-style: italic;
    color: var(--color-text-muted);
    line-height: 1.5;
    margin-bottom: 2rem;
  }

  .modal-intro {
    font-size: 1.0625rem;
    color: var(--color-text-muted);
    line-height: 1.7;
    margin-bottom: 2rem;
  }

  .modal-sections :global(h2) {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 2.5rem;
    color: var(--color-text);
  }

  .modal-sections :global(h2:first-child) {
    margin-top: 0;
  }

  .modal-sections :global(p) {
    font-size: 1.0625rem;
    color: var(--color-text-muted);
    line-height: 1.7;
    margin-bottom: 1rem;
  }

  .modal-sections :global(strong) {
    color: var(--color-text);
    font-weight: 600;
  }

  /* Payment options cards */
  .modal-sections :global(.payment-options) {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
    margin-top: 1.5rem;
  }

  @media (max-width: 640px) {
    .modal-sections :global(.payment-options) {
      grid-template-columns: 1fr;
    }
  }

  .modal-sections :global(.payment-card) {
    background: var(--color-surface-raised);
    border: 1px solid var(--color-border);
    border-radius: 0.75rem;
    padding: 1.5rem;
    transition: all 0.2s ease;
  }

  .modal-sections :global(.payment-card:hover) {
    border-color: var(--color-accent-subtle);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .modal-sections :global(.payment-card h3) {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0 0 0.75rem;
    color: var(--color-text);
  }

  .modal-sections :global(.payment-card p) {
    font-size: 1rem;
    color: var(--color-text-muted);
    line-height: 1.6;
    margin: 0;
  }

  .modal-cta {
    margin-top: 2.5rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
    text-align: center;
  }

  .btn-modal-cta {
    display: inline-block;
    padding: 1rem 2.5rem;
    background: var(--color-accent);
    color: var(--color-btn-text);
    border-radius: 0.625rem;
    font-weight: 600;
    font-size: 1.125rem;
    letter-spacing: -0.01em;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    box-shadow: 0 0 20px var(--color-accent-glow), 0 0 60px var(--color-accent-glow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.08);
    text-decoration: none;
  }

  .btn-modal-cta:hover {
    background: var(--color-accent-hover);
    box-shadow: 0 0 30px var(--color-accent-glow-strong), 0 0 80px var(--color-accent-glow), 0 4px 16px var(--color-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
    text-decoration: none;
  }

  .btn-modal-cta:active {
    transform: translateY(0);
    transition-duration: 0.1s;
  }
</style>
