---
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import Base from "../layouts/Base.astro";
import demiHero from "../assets/case-studies/demi-hero.png";
import upmealsHero from "../assets/case-studies/upmeals-hero.png";

const caseStudyImages: Record<number, ImageMetadata> = {
  1: demiHero,
  2: upmealsHero,
};

const sections = (await getCollection("homepage")).sort(
  (a, b) => a.data.order - b.data.order
);

const rendered = await Promise.all(
  sections.map(async (s) => ({
    ...s,
    rendered: await render(s),
  }))
);

const workEntries = (await getCollection("work")).sort(
  (a, b) => a.data.order - b.data.order
);

const descriptions: Record<number, string> = {
  1: "Complex AI kitchen software that needed to feel simple. We led with operator pain points, not tech jargon, and built a marketing site that makes Demi feel like relief — not another learning curve.",
  2: "Three very different buyers, one brand. We found the common thread — reliability at scale — and built a site where each audience gets spoken to directly without the brand feeling fragmented.",
};

const caseStudies = workEntries.map((entry) => ({
  title: entry.data.title,
  description: descriptions[entry.data.order] ?? entry.data.challenge,
  link: `/work#${entry.data.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')}`,
  image: caseStudyImages[entry.data.order],
}));

const year = new Date().getFullYear();
---

<Base title="Plain Sight | Web Development Agency">
  <main>
    {rendered.map((section) => {
      const { Content } = section.rendered;
      const d = section.data;

      if (d.section === "hero") return (
        <section class="hero">
          <div class="hero-bg-glow" aria-hidden="true"></div>
          <div class="hero-grid-pattern" aria-hidden="true"></div>
          <div class="container">
            <div class="hero-content">
              <h1 class="hero-title">{d.heading}</h1>
              <p class="hero-tagline">{d.subheading}</p>
              {d.cta_text && (
                <div class="hero-actions">
                  <a href={d.cta_link} class="btn btn-primary">{d.cta_text}</a>
                </div>
              )}
            </div>
          </div>
        </section>
      );

      if (d.section === "problem") return (
        <section class="section-problem">
          <div class="container">
            <h2 class="section-problem-title">{d.heading}</h2>
            <div class="section-problem-prose">
              <p>Most small businesses know they need a website, but the process feels <span class="highlight">overwhelming</span>. Too many options, too many cookie-cutter solutions that slap a template on every business like they're all the same.</p>
              <p>What's missing is <span class="highlight">strategy</span>: understanding what your site needs to <em class="highlight">achieve</em>. More customers? More bookings? Better leads?</p>
            </div>
            <p class="section-problem-kicker">If your website isn't driving those results, it's just expensive decoration.</p>
          </div>
        </section>
      );

      if (d.section === "differentiators") return (
        <section class="section section-diff">
          <div class="container">
            <div class="section-diff-header">
              <p class="section-diff-label">Why Plain Sight</p>
              <h2 class="section-diff-title">{d.heading}</h2>
            </div>
            <div class="diff-grid">
              {d.items?.map((item, i) => (
                <div class="diff-card" style={`--card-index: ${i}`}>
                  <div class="diff-card-icon" aria-hidden="true">
                    {i === 0 && (
                      <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="18" />
                        <circle cx="24" cy="24" r="8" />
                        <line x1="24" y1="2" x2="24" y2="12" />
                        <line x1="24" y1="36" x2="24" y2="46" />
                        <line x1="2" y1="24" x2="12" y2="24" />
                        <line x1="36" y1="24" x2="46" y2="24" />
                      </svg>
                    )}
                    {i === 1 && (
                      <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <polygon points="24,4 44,16 24,28 4,16" />
                        <polyline points="4,24 24,36 44,24" />
                        <polyline points="4,32 24,44 44,32" />
                      </svg>
                    )}
                    {i === 2 && (
                      <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M24,2 C24,2 40,10 40,22 C40,34 24,46 24,46 C24,46 8,34 8,22 C8,10 24,2 24,2Z" />
                        <polyline points="26,14 20,26 28,26 22,38" />
                      </svg>
                    )}
                    {i === 3 && (
                      <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8,40 C8,40 16,32 24,32 C32,32 32,16 24,16 C16,16 16,8 24,8 C32,8 40,8 40,8" />
                        <circle cx="8" cy="40" r="3" fill="currentColor" />
                        <circle cx="24" cy="24" r="3" fill="currentColor" />
                        <circle cx="40" cy="8" r="3" fill="currentColor" />
                      </svg>
                    )}
                  </div>
                  <div class="diff-card-number" aria-hidden="true">{String(i + 1).padStart(2, '0')}</div>
                  <h3>{item.title}</h3>
                  <p>{item.description}</p>
                </div>
              ))}
            </div>
          </div>
        </section>
      );

      if (d.section === "process") return (
        <section class="section section-process">
          <div class="container">
            <div class="section-process-header">
              <p class="section-process-label">Our process</p>
              <h2 class="section-process-title">{d.heading}</h2>
            </div>
            <div class="process-panel" data-active="0">
              <div class="process-nav">
                {d.items?.map((item, i) => (
                  <button
                    class="process-nav-item"
                    data-index={i}
                    type="button"
                    aria-controls={`process-detail-${i}`}
                  >
                    <span class="process-nav-number">{String(i + 1).padStart(2, '0')}</span>
                    <span class="process-nav-line" aria-hidden="true"></span>
                    <span class="process-nav-title">{item.title}</span>
                  </button>
                ))}
              </div>
              <div class="process-details">
                {d.items?.map((item, i) => (
                  <div
                    class="process-detail"
                    id={`process-detail-${i}`}
                    data-index={i}
                  >
                    <span class="process-detail-number">{String(i + 1).padStart(2, '0')}</span>
                    <h3 class="process-detail-title">{item.title}</h3>
                    <p class="process-detail-desc">{item.description}</p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>
      );

      if (d.section === "work") return (
        <section class="section section-work" id="work">
          <div class="container">
            <div class="section-work-header">
              <p class="section-work-label">Our work</p>
              <h2 class="section-work-title">{d.heading}</h2>
              {d.intro && <p class="section-work-intro">{d.intro}</p>}
            </div>
            <div class="work-grid">
              {caseStudies.map((study) => (
                <a href={study.link} class="work-card">
                  <div class="work-card-image">
                    {study.image && <Image src={study.image} alt={`${study.title} screenshot`} width={800} />}
                  </div>
                  <div class="work-card-content">
                    <h3 class="work-card-title">{study.title}</h3>
                    <p class="work-card-desc">{study.description}</p>
                    <span class="btn work-card-btn">View case study</span>
                  </div>
                </a>
              ))}
            </div>
          </div>
        </section>
      );

      if (d.section === "cta") return (
        <section class="section section-cta" id="contact">
          <div class="cta-glow" aria-hidden="true"></div>
          <div class="container">
            <div class="cta-content">
              <h2 class="cta-title">{d.heading}</h2>
              <div class="cta-prose">
                <Content />
              </div>
              {d.cta_text && (
                <a href={d.cta_link} class="btn btn-cta">{d.cta_text}</a>
              )}
            </div>
          </div>
        </section>
      );
    })}
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; {year} Plain Sight. All rights reserved.</p>
    </div>
  </footer>

  <script>
    const panel = document.querySelector('.process-panel');
    if (panel) {
      panel.querySelectorAll('.process-nav-item').forEach(item => {
        item.addEventListener('mouseenter', () => {
          panel.setAttribute('data-active', (item as HTMLElement).dataset.index!);
        });
        item.addEventListener('focus', () => {
          panel.setAttribute('data-active', (item as HTMLElement).dataset.index!);
        });
      });
    }
  </script>
</Base>
