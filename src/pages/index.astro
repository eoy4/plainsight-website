---
import { getCollection, render } from "astro:content";
import { Image } from "astro:assets";
import Base from "../layouts/Base.astro";
import CaseStudyCard from "../components/CaseStudyCard.astro";
import CTA from "../components/CTA.astro";
import demiHero from "../assets/case-studies/demi-hero.png";
import upmealsHero from "../assets/case-studies/upmeals-hero.png";
import iconCompass from "../assets/icons/icon-compass.svg";
import iconDisk from "../assets/icons/icon-disk.svg";
import iconRocket from "../assets/icons/icon-rocket.svg";
import iconBulb from "../assets/icons/icon-bulb.svg";

const caseStudyImages: Record<number, ImageMetadata> = {
  1: demiHero,
  2: upmealsHero,
};

const sections = (await getCollection("homepage")).sort(
  (a, b) => a.data.order - b.data.order
);

const rendered = await Promise.all(
  sections.map(async (s) => ({
    ...s,
    rendered: await render(s),
  }))
);

const workEntries = (await getCollection("work")).sort(
  (a, b) => a.data.order - b.data.order
);

const descriptions: Record<number, string> = {
  1: "Complex AI kitchen software that needed to feel simple. We led with operator pain points, not tech jargon, and built a marketing site that makes Demi feel like relief, not another learning curve.",
  2: "Three very different buyers, one brand. We found the common thread, reliability at scale, and built a site where each audience gets spoken to directly without the brand feeling fragmented.",
};

const caseStudies = workEntries.map((entry) => ({
  title: entry.data.title,
  description: descriptions[entry.data.order] ?? entry.data.challenge,
  link: `/work/${entry.id.replace(/^\d+-/, '').replace(/\.md$/, '')}`,
  image: caseStudyImages[entry.data.order],
}));
---

<Base title="Plain Sight | Web Development Agency" navVariant="dark">
  <main>
    {rendered.map((section) => {
      const { Content } = section.rendered;
      const d = section.data;

      if (d.section === "hero") return (
        <section class="dark-section relative min-h-[90vh] flex items-center overflow-hidden bg-[var(--color-bg-dark-hero)] text-[var(--color-text-light)] [--hero-title-gradient-start:var(--color-text-light)] [--hero-title-gradient-end:var(--color-text-light-muted)]">
          <div class="hero-aurora" aria-hidden="true"><div class="hero-aurora-inner"></div></div>
          <div class="container">
            <div class="relative z-1">
              <h1 class="font-heading text-hero font-black leading-[0.85] tracking-tighter mb-[var(--spacing-hero-gap)] pb-[0.15em] bg-gradient-to-br from-[var(--hero-title-gradient-start)] to-[var(--hero-title-gradient-end)] bg-clip-text text-transparent [overflow-wrap:break-word] [word-break:normal] [hyphens:none]">{d.heading}</h1>
              <p class="text-hero-tagline mb-[var(--spacing-hero-cta-gap)] leading-relaxed font-normal max-w-[900px] text-white/70">{d.subheading}</p>
              {d.cta_text && (
                <a href={d.cta_link} class="btn-cta text-hero-cta">{d.cta_text}</a>
              )}
            </div>
          </div>
        </section>
      );

      if (d.section === "problem") return (
        <section class="animate-on-scroll relative py-section max-md:py-16 max-md:overflow-hidden after:content-[''] after:absolute after:top-[30%] after:right-[-20%] after:w-[40%] after:h-[60%] after:bg-[radial-gradient(ellipse_at_center,rgba(126,219,87,0.03)_0%,transparent_60%)] after:pointer-events-none after:z-0">
          <div class="container relative z-1">
            <h2 class="font-heading text-problem-title font-extrabold tracking-tight text-text mb-12 max-md:font-black max-md:leading-none">{d.heading}</h2>
            <div class="max-w-[1100px] text-problem-prose text-text-muted leading-extra-loose mb-12">
              <p class="mb-6">Most small businesses know they need a website, but the process feels <span class="text-btn-text bg-accent px-[0.15em] py-[0.05em] rounded-[0.25em] font-semibold not-italic [box-decoration-break:clone]">overwhelming.</span> Too many options, too many cookie-cutter solutions that slap a template on every business like they're all the same.</p>
              <p class="mb-6">What's missing is <span class="text-btn-text bg-accent px-[0.15em] py-[0.05em] rounded-[0.25em] font-semibold not-italic [box-decoration-break:clone]">strategy:</span> understanding what goals your site needs to achieve. More customers? More bookings? Better leads?</p>
            </div>
            <p class="max-w-[1100px] text-problem-kicker font-semibold leading-extra-loose text-secondary-accessible max-md:text-[1.5rem]">If your website isn't driving those results, it's just expensive decoration.</p>
          </div>
        </section>
      );

      if (d.section === "differentiators") return (
        <section class="section-diff animate-on-scroll relative py-section bg-gradient-to-b from-surface-alt to-surface-gradient-end">
          <div class="container">
            <div class="mb-12">
              <p class="text-15 font-semibold tracking-widest uppercase text-primary">Why Plain Sight</p>
              <h2 class="font-heading text-section-title font-extrabold tracking-tight">{d.heading}</h2>
            </div>
            <div class="grid grid-cols-2 max-md:grid-cols-1 gap-5">
              {d.items?.map((item, i) => {
                const icons = [iconCompass, iconDisk, iconRocket, iconBulb];
                return (
                <div class="bg-bg rounded-2xl p-10 max-md:p-8 relative overflow-hidden shadow-sm [--card-index:{i}]">
                  <div class="mb-5 w-14 h-14 flex items-center justify-center" aria-hidden="true">
                    <img src={icons[i].src} alt="" class={`${i === 1 ? "w-12 h-12" : "w-14 h-14"} [filter:invert(47%)_sepia(85%)_saturate(460%)_hue-rotate(139deg)_brightness(93%)_contrast(91%)]`} />
                  </div>
                  <div class="font-mono text-17 text-text-dim mb-4 tracking-wider" aria-hidden="true">{String(i + 1).padStart(2, '0')} {['STRATEGY', 'EXPERIENCE', 'EXECUTION', 'TRANSPARENCY'][i]}</div>
                  <h3 class="text-36 font-extrabold mb-6 tracking-snug leading-tight">{item.title}</h3>
                  <p class="text-text-muted leading-loose text-[1.1875rem]">{item.description}</p>
                </div>
              );
              })}
            </div>
          </div>
        </section>
      );

      if (d.section === "process") return (
        <section class="section-process animate-on-scroll relative py-30">
          <div class="process-blob-blur" aria-hidden="true">
            <div class="process-blob"></div>
          </div>
          <div class="container">
            <div class="mb-12">
              <p class="text-15 font-semibold tracking-widest uppercase text-accent-hover">Our process</p>
              <h2 class="font-heading text-section-title font-extrabold tracking-tight">{d.heading}</h2>
            </div>
            <div class="process-panel" data-active="0">
              <div class="process-nav">
                {d.items?.map((item, i) => (
                  <button
                    class="process-nav-item"
                    data-index={i}
                    type="button"
                    aria-controls={`process-detail-${i}`}
                  >
                    <span class="process-nav-number">{String(i + 1).padStart(2, '0')}</span>
                    <span class="process-nav-line" aria-hidden="true"></span>
                    <span class="process-nav-title">{item.title}</span>
                  </button>
                ))}
              </div>
              <div class="process-details">
                {d.items?.map((item, i) => (
                  <div
                    class="process-detail"
                    id={`process-detail-${i}`}
                    data-index={i}
                  >
                    <span class="process-detail-number">{String(i + 1).padStart(2, '0')}</span>
                    <h3 class="process-detail-title">{item.title}</h3>
                    <p class="process-detail-desc">{item.description}</p>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>
      );

      if (d.section === "testimonial") return (
        <section class="animate-on-scroll relative py-section overflow-hidden bg-bg">
          <div class="container relative z-1">
            <div class="absolute top-[-0.1em] right-0 font-heading text-[clamp(14rem,25vw,22rem)] font-black leading-none text-text opacity-[0.03] pointer-events-none select-none z-0" aria-hidden="true">&ldquo;</div>
            <div class="mb-12">
              <p class="text-15 font-semibold tracking-widest uppercase text-primary">Client Testimonials</p>
              <h2 class="font-heading text-section-title font-extrabold tracking-tight">Results that speak</h2>
            </div>
            <div class="flex items-stretch gap-10 max-w-[900px] max-md:gap-6">
              <div class="w-[3px] flex-shrink-0 rounded-[2px] bg-gradient-to-b from-accent to-pop" aria-hidden="true"></div>
              <blockquote class="m-0 p-0">
                <p class="font-sans text-[1.75rem] font-medium leading-[1.5] tracking-[-0.01em] text-text-muted mb-8 max-md:mb-6">&ldquo;They nailed the strategy, the design, and the execution. We finally have a site that accurately represents what we do .&rdquo;</p>
                <footer class="flex items-center gap-4">
                  <div class="flex flex-col gap-[0.15rem]">
                    <span class="font-bold text-[1.375rem] text-text tracking-[-0.01em]">Mohit Wasan</span>
                    <span class="text-[1.125rem] text-text-muted">CEO, UpMeals</span>
                  </div>
                </footer>
              </blockquote>
            </div>
          </div>
        </section>
      );

      if (d.section === "basics") return (
        <section class="section-basics animate-on-scroll relative py-section bg-gradient-to-b from-surface-alt to-surface-gradient-end">
          <div class="container">
            <div class="mb-12">
              <p class="text-15 font-semibold tracking-widest uppercase text-secondary-accessible">What you get</p>
              <h2 class="font-heading text-section-title font-extrabold tracking-tight">{d.heading}</h2>
            </div>
            <ul class="list-none flex flex-col max-w-[1100px]">
              {d.items?.map((item, i) => (
                <li class="grid grid-cols-[320px_1fr] max-md:grid-cols-1 gap-x-20 max-md:gap-y-3 items-center py-8 border-b border-border-alt first:border-t first:border-border-alt">
                  <div class="flex items-center gap-3">
                    <span class="shrink-0 w-16 h-16 flex items-center justify-center text-pop" aria-hidden="true">
                      {i === 0 && (
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                          <rect x="2" y="3" width="20" height="14" rx="2" />
                          <line x1="8" y1="21" x2="16" y2="21" />
                          <line x1="12" y1="17" x2="12" y2="21" />
                        </svg>
                      )}
                      {i === 1 && (
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                          <polygon points="13,2 3,14 12,14 11,22 21,10 12,10" />
                        </svg>
                      )}
                      {i === 2 && (
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                          <circle cx="11" cy="11" r="8" />
                          <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                      )}
                      {i === 3 && (
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                          <polyline points="16,18 22,12 16,6" />
                          <polyline points="8,6 2,12 8,18" />
                        </svg>
                      )}
                      {i === 4 && (
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8">
                          <path d="M20,21v-2a4,4,0,0,0-4-4H8a4,4,0,0,0-4,4v2" />
                          <circle cx="12" cy="7" r="4" />
                        </svg>
                      )}
                    </span>
                    <h3 class="text-[1.75rem] font-bold tracking-snug text-text whitespace-nowrap">{item.title}</h3>
                  </div>
                  <div>
                    <p class="leading-loose text-[1.125rem]" style="color: rgba(45, 49, 66, 0.80);">{item.description}</p>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        </section>
      );

      if (d.section === "work") return (
        <section class="section-work animate-on-scroll relative py-section" id="work">
          <div class="container">
            <div class="mb-12">
              <p class="text-15 font-semibold tracking-widest uppercase text-primary">Our work</p>
              <h2 class="font-heading text-section-title font-extrabold tracking-tight">{d.heading}</h2>
              {d.intro && <p class="text-text-muted mt-4 leading-loose">{d.intro}</p>}
            </div>
            <div class="grid grid-cols-2 max-md:grid-cols-1 gap-12">
              {caseStudies.map((study) => (
                <CaseStudyCard
                  title={study.title}
                  description={study.description}
                  link={study.link}
                  image={study.image}
                />
              ))}
            </div>
          </div>
        </section>
      );

      if (d.section === "cta") return (
        <CTA heading={d.heading} ctaText={d.cta_text} ctaLink={d.cta_link}>
          <Content />
        </CTA>
      );
    })}
  </main>

  <script>
    const panel = document.querySelector('.process-panel');
    const section = document.querySelector('.section-process');
    if (panel && section) {
      const isMobile = () => window.innerWidth <= 768;

      panel.querySelectorAll('.process-nav-item').forEach(item => {
        const index = (item as HTMLElement).dataset.index!;

        // Click handler for both mobile (accordion) and desktop
        item.addEventListener('click', () => {
          // Always keep one panel open - no collapsing
          panel.setAttribute('data-active', index);
          section.setAttribute('data-active', index);
        });

        // Desktop hover behavior
        if (!isMobile()) {
          item.addEventListener('mouseenter', () => {
            panel.setAttribute('data-active', index);
            section.setAttribute('data-active', index);
          });
        }

        item.addEventListener('focus', () => {
          panel.setAttribute('data-active', index);
          section.setAttribute('data-active', index);
        });
      });

      // Set initial state
      section.setAttribute('data-active', '0');
    }

  </script>

</Base>
