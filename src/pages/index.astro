---
import { getCollection, render } from "astro:content";
import Base from "../layouts/Base.astro";
import CaseStudyCard from "../components/CaseStudyCard.astro";

const sections = (await getCollection("homepage")).sort(
  (a, b) => a.data.order - b.data.order
);

const rendered = await Promise.all(
  sections.map(async (s) => ({
    ...s,
    rendered: await render(s),
  }))
);

const workEntries = (await getCollection("work")).sort(
  (a, b) => a.data.order - b.data.order
);

const descriptions: Record<number, string> = {
  1: "Complex AI kitchen software that needed to feel simple. We led with operator pain points, not tech jargon, and built a marketing site that makes Demi feel like relief — not another learning curve.",
  2: "Three very different buyers, one brand. We found the common thread — reliability at scale — and built a site where each audience gets spoken to directly without the brand feeling fragmented.",
};

const caseStudies = workEntries.map((entry) => ({
  title: entry.data.title,
  description: descriptions[entry.data.order] ?? entry.data.challenge,
  techStack: entry.data.tech.split(",").map((t: string) => t.trim()),
  link: `/work#${entry.data.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')}`,
}));

const year = new Date().getFullYear();
---

<Base title="Plain Sight | Web Development Agency">
  <main>
    {rendered.map((section) => {
      const { Content } = section.rendered;
      const d = section.data;

      if (d.section === "hero") return (
        <section class="hero">
          <div class="container">
            <div class="hero-content">
              <h1 class="hero-title">{d.heading}</h1>
              <p class="hero-tagline">{d.subheading}</p>
              {d.cta_text && <a href={d.cta_link} class="btn">{d.cta_text}</a>}
            </div>
          </div>
        </section>
      );

      if (d.section === "problem") return (
        <section class="section">
          <div class="container">
            <h2 class="section-title">{d.heading}</h2>
            <div class="section-prose">
              <Content />
            </div>
          </div>
        </section>
      );

      if (d.section === "differentiators") return (
        <section class="section">
          <div class="container">
            <h2 class="section-title">{d.heading}</h2>
            <div class="items-grid">
              {d.items?.map((item) => (
                <div class="item-card">
                  <h3>{item.title}</h3>
                  <p>{item.description}</p>
                </div>
              ))}
            </div>
          </div>
        </section>
      );

      if (d.section === "process") return (
        <section class="section">
          <div class="container">
            <h2 class="section-title">{d.heading}</h2>
            <div class="process-grid">
              {d.items?.map((item) => (
                <div class="process-card">
                  <h3>{item.title}</h3>
                  <p>{item.description}</p>
                </div>
              ))}
            </div>
          </div>
        </section>
      );

      if (d.section === "work") return (
        <section class="section" id="work">
          <div class="container">
            <h2 class="section-title">{d.heading}</h2>
            {d.intro && <p class="section-intro">{d.intro}</p>}
            <div class="case-studies-grid">
              {caseStudies.map((study) => (
                <CaseStudyCard
                  title={study.title}
                  description={study.description}
                  techStack={study.techStack}
                  link={study.link}
                />
              ))}
            </div>
          </div>
        </section>
      );

      if (d.section === "cta") return (
        <section class="section" id="contact">
          <div class="container">
            <h2 class="section-title">{d.heading}</h2>
            <div class="section-prose">
              <Content />
            </div>
            {d.cta_text && <a href={d.cta_link} class="btn">{d.cta_text}</a>}
          </div>
        </section>
      );
    })}
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; {year} Plain Sight. All rights reserved.</p>
    </div>
  </footer>
</Base>
